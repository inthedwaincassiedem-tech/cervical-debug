<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cervical Debug Pro v2.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { background-color: #0a0a0a; color: #00ff00; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .glow { text-shadow: 0 0 10px #00ff00; }
        #output_canvas { width: 100%; height: 100%; object-fit: cover; }
        .status-box { background: rgba(0, 0, 0, 0.7); border: 1px solid rgba(0, 255, 0, 0.3); }
    </style>
</head>
<body class="flex flex-col h-screen p-4">

    <header class="flex justify-between border-b border-green-900 pb-2 mb-2 text-[10px]">
        <span class="glow">ENGINE: CERVICAL_CORE_V2.2</span>
        <span id="timestamp"></span>
    </header>

    <main class="relative flex-grow border border-green-900 rounded overflow-hidden bg-black">
        <video id="input_video" class="hidden" playsinline></video>
        <canvas id="output_canvas"></canvas>

        <div class="absolute top-2 left-2 space-y-2 z-10">
            <div class="status-box p-2">
                <div class="text-[8px] opacity-60 uppercase">Cervical Angle</div>
                <div id="angle-val" class="text-xl font-bold tracking-tighter">--°</div>
            </div>
            <div class="status-box p-2">
                <div class="text-[8px] opacity-60 uppercase">Mech Load</div>
                <div id="load-val" class="text-xl font-bold tracking-tighter text-orange-500">--kg</div>
            </div>
        </div>

        <div id="repair-modal" class="hidden absolute inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-8 text-center">
            <div class="text-orange-500 animate-pulse mb-2 text-xs font-bold">CRITICAL_OVERLOAD_DETECTED</div>
            <h2 id="step-title" class="text-xl font-bold mb-4 tracking-tight">系统修复程序</h2>
            <p id="step-desc" class="text-xs opacity-80 mb-8 leading-relaxed h-12">检测到颈椎力矩异常，请执行以下复位动作。</p>
            <div id="timer-display" class="text-6xl font-bold mb-10 text-white">10s</div>
            <button id="repair-action-btn" onclick="executeRepairStep()" class="border-2 border-green-500 px-10 py-3 text-sm font-bold active:bg-green-500 active:text-black transition-all">
                立即执行
            </button>
        </div>
        
        <div id="loading-overlay" class="absolute inset-0 bg-black flex flex-col items-center justify-center z-40">
            <div class="text-green-500 animate-pulse mb-2">INIT_AI_MODELS...</div>
            <div class="text-[8px] opacity-50">正在加载 MediaPipe Pose 引擎</div>
        </div>
    </main>

    <footer class="mt-4 flex flex-col gap-3">
        <div class="flex justify-between text-[8px] opacity-50 uppercase tracking-widest">
            <span>Stability: <span id="stab-val">0%</span></span>
            <span>Status: <span id="sys-status">Initializing</span></span>
        </div>
        <button id="main-btn" disabled class="w-full bg-green-900/50 text-green-100 py-3 rounded text-[10px] font-bold tracking-widest border border-green-800 transition-all uppercase">
            等待姿态锁定...
        </button>
    </footer>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const angleDisplay = document.getElementById('angle-val');
        const loadDisplay = document.getElementById('load-val');
        const mainBtn = document.getElementById('main-btn');
        const repairModal = document.getElementById('repair-modal');
        const loadingOverlay = document.getElementById('loading-overlay');

        const REPAIR_STEPS = [
            { title: "STEP 01: 寰枕卸载", desc: "头后缩，手掌抵住后脑勺向后微发力，重塑深层肌肉支撑", time: 10 },
            { title: "STEP 02: 胸椎复位", desc: "双臂抱头，靠在椅背向上方延展，打开胸廓减压", time: 15 },
            { title: "STEP 03: 神经激活", desc: "侧头至极限，对侧手掌向下压，解除神经卡压", time: 10 }
        ];
        let currentStep = 0;

        // 1. 初始化 Pose 引擎
        const pose = new Pose({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
        });

        pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        pose.onResults(onResults);

        // 2. 核心算法回调
        function onResults(results) {
            if (loadingOverlay) loadingOverlay.style.display = 'none';
            document.getElementById('sys-status').innerText = "Running";

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                const ear = results.poseLandmarks[7]; // 左耳
                const shoulder = results.poseLandmarks[11]; // 左肩

                if (ear.visibility > 0.5 && shoulder.visibility > 0.5) {
                    const dx = (shoulder.x - ear.x);
                    const dy = (shoulder.y - ear.y);
                    const angle = Math.abs(Math.atan2(dx, dy) * (180 / Math.PI));
                    const load = (5 + (angle * 0.45)).toFixed(1);

                    // 更新 UI
                    angleDisplay.innerText = `${angle.toFixed(1)}°`;
                    loadDisplay.innerText = `${load}kg`;
                    
                    // 绘制可视化
                    drawMeasures(ear, shoulder);

                    // 阈值判断
                    if (angle > 25) {
                        mainBtn.disabled = false;
                        mainBtn.innerText = "CRITICAL: START REPAIR";
                        mainBtn.classList.add('bg-orange-600', 'border-orange-400');
                        mainBtn.onclick = () => repairModal.classList.remove('hidden');
                    }
                }
            }
            canvasCtx.restore();
        }

        function drawMeasures(ear, shoulder) {
            const w = canvasElement.width;
            const h = canvasElement.height;
            canvasCtx.strokeStyle = "#00ff00";
            canvasCtx.lineWidth = 2;
            canvasCtx.beginPath();
            canvasCtx.moveTo(ear.x * w, ear.y * h);
            canvasCtx.lineTo(shoulder.x * w, shoulder.y * h);
            canvasCtx.stroke();
        }

        // 3. 修复交互逻辑
        function executeRepairStep() {
            const btn = document.getElementById('repair-action-btn');
            btn.style.visibility = 'hidden';
            
            const step = REPAIR_STEPS[currentStep];
            document.getElementById('step-title').innerText = step.title;
            document.getElementById('step-desc').innerText = step.desc;
            
            let timeLeft = step.time;
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer-display').innerText = timeLeft + "s";
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    currentStep++;
                    if (currentStep < REPAIR_STEPS.length) {
                        btn.style.visibility = 'visible';
                        btn.innerText = "NEXT_PHASE";
                    } else {
                        finishRepair();
                    }
                }
            }, 1000);
        }

        function finishRepair() {
            repairModal.innerHTML = `
                <div class="text-green-500 font-bold mb-4">SYSTEM_FIXED</div>
                <div class="text-[10px] text-left space-y-4 mb-10 leading-relaxed">
                    [INFO] 颈椎力学矢量已重置<br>
                    [INFO] 局部血氧饱和度预期提升: 25%<br>
                    [INFO] 建议维持姿态，2小时后重新巡检
                </div>
                <button onclick="location.reload()" class="bg-green-600 text-black px-10 py-3 font-bold text-xs">EXIT_AND_SAVE</button>
            `;
        }

        // 4. 启动相机
        const camera = new Camera(videoElement, {
            onFrame: async () => { await pose.send({image: videoElement}); },
            width: 640, height: 480
        });
        camera.start();

        // 窗口适配
        window.addEventListener('resize', () => {
            canvasElement.width = canvasElement.clientWidth;
            canvasElement.height = canvasElement.clientHeight;
        });
        canvasElement.width = canvasElement.clientWidth;
        canvasElement.height = canvasElement.clientHeight;
        setInterval(() => { document.getElementById('timestamp').innerText = new Date().toISOString().slice(11, 19); }, 1000);
    </script>
</body>
</html>
